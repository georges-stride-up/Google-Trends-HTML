<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin Trends Generator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <style>
    #status { margin-top: 20px; padding: 10px; border-radius: 4px; }
    .success { color: #008a00; font-weight: bold; background: #e6ffed; padding: 10px; border: 1px solid #008a00; }
    .error { color: #cf222e; background: #ffebe9; padding: 10px; border: 1px solid #cf222e; }
    small.meta { display:block; color:#555; margin-top:6px; }
  </style>
</head>
<body>
  <h1>üöÄ Trends Generator</h1>

  <label>1. Deployment mode</label>
  <select id="mode">
    <option value="server">Server-side publish (recommended)</option>
    <option value="direct">Direct publish from browser (legacy, insecure)</option>
  </select>

  <div id="server-note" style="margin-top:8px">
    <small class="meta">Server endpoint (e.g. Vercel) must be deployed with a GITHUB_TOKEN secret. Default server endpoint: <code>/api/publish</code>.</small>
  </div>

  <label style="margin-top:10px">2. Ton GitHub Token (PAT) ‚Äî only needed for Direct mode</label>
  <input type="password" id="ghToken" placeholder="github_pat_..." />

  <label style="margin-top:10px">3. Script Google Trends (Embed)</label>
  <textarea id="rawScript" rows="6" placeholder='<script type="text/javascript" ...'></textarea>

  <button onclick="publish()">G√©n√©rer et Publier</button>

  <div id="status"></div>

  <script>
    const REPO_NAME = "Google-Trends-HTML";
    const REPO_OWNER = "georges-stride-up";

    function slugify(s){
      return String(s||'').toLowerCase()
        .replace(/[\s'‚Äô]+/g,'-')
        .replace(/[^a-z0-9\-_,]/g,'')
        .replace(/-+/g,'-')
        .replace(/(^-|-$)/g,'');
    }

    function buildExploreQuery({primaryKeyword, primaryTime, primaryGeo, lang}) {
      const parts = [];
      parts.push('date=' + encodeURIComponent(primaryTime));
      if (primaryGeo) parts.push('geo=' + encodeURIComponent(primaryGeo));
      parts.push('q=' + encodeURIComponent(primaryKeyword));
      if (lang) parts.push('hl=' + encodeURIComponent(lang));
      return parts.join('&');
    }

    window.onload = function() {
      const savedToken = localStorage.getItem('gh_token');
      if (savedToken) document.getElementById('ghToken').value = savedToken;
      document.getElementById('mode').value = 'server';
    };

    async function publish() {
      const mode = document.getElementById('mode').value;
      const token = document.getElementById('ghToken').value;
      const input = document.getElementById('rawScript').value || '';
      const status = document.getElementById('status');

      if (mode === 'direct' && !token) { alert("Oublie pas le token !"); return; }

      // Parse items
      const keywordMatches = [...input.matchAll(/"keyword"\s*:\s*"(.*?)"/g)].map(m=>m[1]);
      const timeMatches = [...input.matchAll(/"time"\s*:\s*"(.*?)"/g)].map(m=>m[1]);
      const geoMatches = [...input.matchAll(/"geo"\s*:\s*"(.*?)"/g)].map(m=>m[1]);
      const langMatch = input.match(/hl=([^&"]+)/);
      const primaryKeyword = keywordMatches[0] || (keywordMatches.length ? keywordMatches.join(',') : '');
      const primaryTime = timeMatches[0] || 'today 12-m';
      const primaryGeo = (geoMatches[0] && geoMatches[0] !== '') ? geoMatches[0] : '';
      const lang = langMatch ? decodeURIComponent(langMatch[1]) : 'en-US';

      if (!primaryKeyword || !primaryTime) {
        status.innerHTML = "<div class='error'>‚ùå Script invalide (mot-cl√© ou p√©riode non trouv√©s).</div>";
        return;
      }

      // Prepare filename components (keyword_countrycode_period.html)
const safeKw = slugify(primaryKeyword);
const safeGeo = primaryGeo ? slugify(primaryGeo) : 'allgeo';
const safeTime = slugify(primaryTime.replace(/\s+/g,'-'));
const filename = `${safeKw}_${safeGeo}_${safeTime}.html`;

const displayTitle =
  primaryKeyword + (primaryGeo ? ' ‚Äî ' + primaryGeo : '') + ' ‚Äî ' + primaryTime;

      // Build comparison items
      const comparisonItems = keywordMatches.map((k,i)=>
        ({ keyword: k,
           geo: geoMatches[i] || geoMatches[0] || primaryGeo || '',
           time: timeMatches[i] || primaryTime
         })
      );

      const comparisonItemsString = comparisonItems.map(ci =>
        `{\"keyword\":\"${ci.keyword}\",\"geo\":\"${ci.geo}\",\"time\":\"${ci.time}\"}`
      ).join(',');

      // Build canonical exploreQuery & guestPath
      const canonicalExploreQuery = buildExploreQuery({
        primaryKeyword,
        primaryTime,
        primaryGeo,
        lang
      });
      const guestPath = `https://trends.google.com/trends/embed/`;

      const finalHTML = `<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>${primaryKeyword}</title><style>body,html{margin:0;padding:0;height:100%;overflow:hidden;}#c{width:100%;height:100vh;}</style></head>
<body><div id="c">
<script type="text/javascript" src="https://ssl.gstatic.com/trends_nrtr/4349_RC01/embed_loader.js"></script>
<script type="text/javascript">
trends.embed.renderExploreWidget("TIMESERIES", {\"comparisonItem\":[${comparisonItemsString}],\"category\":0,\"property\":\"\"}, {\"exploreQuery\":\"${canonicalExploreQuery}\",\"guestPath\":\"${guestPath}\"});
<\/script></div></body></html>`;

      status.innerHTML = "‚è≥ Pr√©paration...";

      if (mode === 'server') {
        // Call the serverless endpoint (deployed by you) to create the file.
        // If you deploy to a different host, update endpoint to the deployed URL (e.g. https://your-app.vercel.app/api/publish)
        const endpoint = 'https://google-trends-html.vercel.app/api/publish';
        try {
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              repoOwner: REPO_OWNER,
              repoName: REPO_NAME,
              filename,
              message: `Add/Update Trend: ${primaryKeyword}`,
              content: finalHTML,
              displayTitle
            })
          });
          const j = await res.json();
          if (!res.ok) {
            status.innerHTML = `<div class="error">‚ùå Server error: ${j?.message || res.statusText}</div>`;
            return;
          }
          status.innerHTML = `<div class="success">‚úÖ Publi√© via serveur: <a href="${j.html_url}" target="_blank">${filename}</a></div>`;
          return;
        } catch (e) {
          status.innerHTML = `<div class="error">‚ùå Erreur serveur: ${e.message}</div>`;
          return;
        }
      } else {
        // Legacy direct publish (keeps existing behavior). Token is used from browser. Not recommended.
        localStorage.setItem('gh_token', token);
        status.innerHTML = "‚è≥ Envoi direct √† GitHub...";
        const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filename}`;
        try {
          // get sha if exists
          let sha = null;
          const checkRes = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` }});
          if (checkRes.ok) {
            const existingFileData = await checkRes.json();
            sha = existingFileData.sha;
          }
          const response = await fetch(url, {
            method: 'PUT',
            headers: {'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json'},
            body: JSON.stringify({
              message: `Add/Update Trend: ${primaryKeyword}`,
              content: btoa(unescape(encodeURIComponent(finalHTML))),
              sha: sha
            })
          });
          if (!response.ok) {
            const err = await response.json();
            status.innerHTML = `<div class="error">‚ùå Erreur API : ${err.message}</div>`;
            return;
          }
          status.innerHTML = `<div class="success">‚úÖ Fichier cr√©√© : ${filename}</div>`;
        } catch (err) {
          status.innerHTML = `<div class="error">‚ùå Erreur inattendue : ${err.message}</div>`;
        }
      }
    }
  </script>
</body>
</html>
