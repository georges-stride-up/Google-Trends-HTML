<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin Trends Generator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <style>
    #status { margin-top: 20px; padding: 10px; border-radius: 4px; }
    .success { color: #008a00; font-weight: bold; background: #e6ffed; padding: 10px; border: 1px solid #008a00; }
    .error { color: #cf222e; background: #ffebe9; padding: 10px; border: 1px solid #cf222e; }
    small.meta { display:block; color:#555; margin-top:6px; }
  </style>
</head>
<body>

<h1>üöÄ Trends Generator</h1>

<label>1. Deployment mode</label>
<select id="mode">
  <option value="server">Server-side publish (recommended)</option>
  <option value="direct">Direct publish from browser (legacy, insecure)</option>
</select>

<div id="server-note" style="margin-top:8px">
  <small class="meta">
    Server endpoint must be deployed with a <code>GITHUB_TOKEN</code>.
    Default endpoint: <code>/api/publish</code>
  </small>
</div>

<label style="margin-top:10px">
  2. Ton GitHub Token (PAT) ‚Äî only needed for Direct mode
</label>
<input type="password" id="ghToken" placeholder="github_pat_..." />

<label style="margin-top:10px">
  3. Script Google Trends (Embed)
</label>
<textarea id="rawScript" rows="6" placeholder='<script type="text/javascript" ...'></textarea>

<button id="publishBtn">G√©n√©rer et Publier</button>

<div id="status"></div>

<script>
/* =======================
   CONFIG
======================= */
const REPO_NAME = "Google-Trends-HTML";
const REPO_OWNER = "georges-stride-up";
const ENDPOINT = "https://google-trends-html.vercel.app/api/publish";

/* =======================
   HELPERS
======================= */
function slugify(s) {
  return String(s || '')
    .toLowerCase()
    .replace(/[\s'‚Äô]+/g, '-')
    .replace(/[^a-z0-9\-_,]/g, '')
    .replace(/-+/g, '-')
    .replace(/(^-|-$)/g, '');
}

function buildExploreQuery({ primaryKeyword, primaryTime, primaryGeo, lang }) {
  const parts = [];
  parts.push('date=' + encodeURIComponent(primaryTime));
  if (primaryGeo) parts.push('geo=' + encodeURIComponent(primaryGeo));
  parts.push('q=' + encodeURIComponent(primaryKeyword));
  if (lang) parts.push('hl=' + encodeURIComponent(lang));
  return parts.join('&');
}

/* =======================
   INIT
======================= */
window.addEventListener('DOMContentLoaded', () => {
  const savedToken = localStorage.getItem('gh_token');
  if (savedToken) document.getElementById('ghToken').value = savedToken;
  document.getElementById('mode').value = 'server';

  document
    .getElementById('publishBtn')
    .addEventListener('click', publish);
});

/* =======================
   MAIN
======================= */
async function publish() {
  const mode = document.getElementById('mode').value;
  const token = document.getElementById('ghToken').value;
  const input = document.getElementById('rawScript').value || '';
  const status = document.getElementById('status');

  status.innerHTML = '';

  if (mode === 'direct' && !token) {
    alert("Oublie pas le token !");
    return;
  }

  // Parse embed script
  const keywordMatches = [...input.matchAll(/"keyword"\s*:\s*"(.*?)"/g)].map(m => m[1]);
  const timeMatches = [...input.matchAll(/"time"\s*:\s*"(.*?)"/g)].map(m => m[1]);
  const geoMatches = [...input.matchAll(/"geo"\s*:\s*"(.*?)"/g)].map(m => m[1]);
  const langMatch = input.match(/hl=([^&"]+)/);

  const primaryKeyword = keywordMatches[0] || '';
  const primaryTime = timeMatches[0] || 'today 12-m';
  const primaryGeo = geoMatches[0] || '';
  const lang = langMatch ? decodeURIComponent(langMatch[1]) : 'en-US';

  if (!primaryKeyword) {
    status.innerHTML = "<div class='error'>‚ùå Script invalide (mot-cl√© non trouv√©).</div>";
    return;
  }

  const safeKw = slugify(primaryKeyword);
  const safeGeo = primaryGeo ? slugify(primaryGeo) : 'allgeo';
  const safeTime = slugify(primaryTime.replace(/\s+/g, '-'));
  const filename = `${safeKw}_${safeGeo}_${safeTime}.html`;

  const displayTitle =
    primaryKeyword + (primaryGeo ? ' ‚Äî ' + primaryGeo : '') + ' ‚Äî ' + primaryTime;

  const comparisonItems = keywordMatches.map((k, i) => ({
    keyword: k,
    geo: geoMatches[i] || primaryGeo || '',
    time: timeMatches[i] || primaryTime
  }));

  const comparisonItemsString = comparisonItems
    .map(ci =>
      `{"keyword":"${ci.keyword}","geo":"${ci.geo}","time":"${ci.time}"}`
    )
    .join(',');

  const canonicalExploreQuery = buildExploreQuery({
    primaryKeyword,
    primaryTime,
    primaryGeo,
    lang
  });

  const finalHTML =
`<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>${primaryKeyword}</title>
<style>
body,html{margin:0;padding:0;height:100%;overflow:hidden;}
#c{width:100%;height:100vh;}
</style>
</head>
<body>
<div id="c">
<script src="https://ssl.gstatic.com/trends_nrtr/4349_RC01/embed_loader.js"><\/script>
<script>
trends.embed.renderExploreWidget(
  "TIMESERIES",
  {"comparisonItem":[${comparisonItemsString}],"category":0,"property":""},
  {"exploreQuery":"${canonicalExploreQuery}","guestPath":"https://trends.google.com/trends/embed/"}
);
<\/script>
</div>
</body>
</html>`;

  status.innerHTML = "‚è≥ Pr√©paration...";

  if (mode === 'server') {
    try {
      const res = await fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          repoOwner: REPO_OWNER,
          repoName: REPO_NAME,
          filename,
          message: `Add/Update Trend: ${primaryKeyword}`,
          content: finalHTML,
          displayTitle
        })
      });

      const j = await res.json();

      if (!res.ok) {
        status.innerHTML = `<div class="error">‚ùå ${j.message || res.statusText}</div>`;
        return;
      }

      status.innerHTML =
        `<div class="success">‚úÖ Publi√© : <a href="${j.html_url}" target="_blank">${filename}</a></div>`;

    } catch (e) {
      status.innerHTML = `<div class="error">‚ùå ${e.message}</div>`;
    }
  }
}
</script>

</body>
</html>
