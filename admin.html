<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin Trends Generator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <style>
    #status { margin-top: 20px; padding: 10px; border-radius: 4px; }
    .success { color: #008a00; font-weight: bold; background: #e6ffed; padding: 10px; border: 1px solid #008a00; }
    .error { color: #cf222e; background: #ffebe9; padding: 10px; border: 1px solid #cf222e; }
    small.meta { display:block; color:#555; margin-top:6px; }
  </style>
</head>
<body>
  <h1>üöÄ Trends Generator</h1>

  <label>1. Ton GitHub Token (PAT)</label>
  <input type="password" id="ghToken" placeholder="github_pat_...">
  <small>Le token est m√©moris√© localement dans ton navigateur (risque de s√©curit√© ‚Äî voir notes).</small>

  <label>2. Script Google Trends (Embed)</label>
  <textarea id="rawScript" rows="6" placeholder='<script type="text/javascript" ...'></textarea>

  <button onclick="publish()">G√©n√©rer et Publier</button>

  <div id="status"></div>

  <script>
    const REPO_NAME = "Google-Trends-HTML";
    const REPO_OWNER = "georges-stride-up";

    // Helpers
    function slugify(s){
      return String(s||'').toLowerCase()
        .replace(/[\s'‚Äô]+/g,'-')
        .replace(/[^a-z0-9\-_,]/g,'')
        .replace(/-+/g,'-')
        .replace(/(^-|-$)/g,'');
    }

    function decodeBase64Unicode(str) {
      return decodeURIComponent(Array.prototype.map.call(atob(str), function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
    }

    window.onload = function() {
      const urlParams = new URLSearchParams(window.location.search);
      const keyFromUrl = urlParams.get('key');
      if (keyFromUrl) {
        localStorage.setItem('gh_token', keyFromUrl);
        window.history.replaceState({}, document.title, window.location.pathname);
        alert("‚úÖ Cl√© API enregistr√©e avec succ√®s !");
      }
      const savedToken = localStorage.getItem('gh_token');
      if (savedToken) document.getElementById('ghToken').value = savedToken;
    };

    async function publish() {
      const token = document.getElementById('ghToken').value;
      const input = document.getElementById('rawScript').value || '';
      const status = document.getElementById('status');

      if(!token) { alert("Oublie pas le token !"); return; }
      localStorage.setItem('gh_token', token);

      // Parse multiple items
      const keywordMatches = [...input.matchAll(/"keyword"\s*:\s*"(.*?)"/g)].map(m=>m[1]);
      const timeMatches = [...input.matchAll(/"time"\s*:\s*"(.*?)"/g)].map(m=>m[1]);
      const geoMatches = [...input.matchAll(/"geo"\s*:\s*"(.*?)"/g)].map(m=>m[1]);
      const queryMatch = input.match(/"exploreQuery"\s*:\s*"(.*?)"/);
      const exploreQuery = queryMatch ? queryMatch[1] : '';

      const primaryKeyword = keywordMatches[0] || (keywordMatches.length ? keywordMatches.join(',') : '');
      const primaryTime = timeMatches[0] || 'today 12-m';
      const geoDisplay = geoMatches.length ? geoMatches.join(',') : '';

      if (!primaryKeyword || !primaryTime) {
        status.innerHTML = "<div class='error'>‚ùå Script invalide (mot-cl√© ou p√©riode non trouv√©s).</div>";
        return;
      }

      // filename: keyword[_geo-geo...]_time.html
      const safeKw = slugify(primaryKeyword);
      const safeGeos = geoMatches.length ? geoMatches.map(g=>slugify(g)).join('-') : 'allgeo';
      const safeTime = slugify(primaryTime.replace(/\s+/g,'-'));
      const filename = `${safeKw}${geoMatches.length?`_${safeGeos}`:''}_${safeTime}.html`;

      // display title for index
      const displayTitle = `${primaryKeyword}${geoDisplay?` ‚Äî ${geoDisplay}`:''} ‚Äî ${primaryTime}`;

      // build trend page HTML (uses stable guestPath)
      const comparisonItems = keywordMatches.map((k,i)=>
        `{\"keyword\":\"${k}\",\"geo\":\"${geoMatches[i]||geoMatches[0]||''}\",\"time\":\"${timeMatches[i]||primaryTime}\"}`
      ).join(',');

      const finalHTML = `<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>${primaryKeyword}</title><style>body,html{margin:0;padding:0;height:100%;overflow:hidden;}#c{width:100%;height:100vh;}</style></head>
<body><div id="c">
<script type="text/javascript" src="https://ssl.gstatic.com/trends_nrtr/4349_RC01/embed_loader.js"><\/script>
<script type="text/javascript">
trends.embed.renderExploreWidget("TIMESERIES", {\"comparisonItem\":[${comparisonItems}],\"category\":0,\"property\":\"\"}, {\"exploreQuery\":\"${exploreQuery}\",\"guestPath\":\"https://trends.google.com/trends/embed/\"});
<\/script></div></body></html>`;

      status.innerHTML = "‚è≥ V√©rification et envoi √† GitHub...";
      const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filename}`;

      try {
        // Get existing SHA if file exists
        let sha = null;
        const checkRes = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
        if (checkRes.ok) {
          const existingFileData = await checkRes.json();
          sha = existingFileData.sha;
        }

        // Create/Update the trend file
        const response = await fetch(url, {
          method: 'PUT',
          headers: {'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json'},
          body: JSON.stringify({
            message: `Add/Update Trend: ${primaryKeyword}`,
            content: btoa(unescape(encodeURIComponent(finalHTML))),
            sha: sha
          })
        });

        if (!response.ok) {
          const err = await response.json();
          status.innerHTML = `<div class="error">‚ùå Erreur API lors de la cr√©ation du fichier : ${err.message}</div>`;
          return;
        }

        // Try to update index.html to add the human-friendly link (will skip if already present)
        try {
          const indexUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/index.html`;
          const idxRes = await fetch(indexUrl, { headers: { 'Authorization': `Bearer ${token}` } });
          if (idxRes.ok) {
            const idxData = await idxRes.json();
            const idxSha = idxData.sha;
            const raw = decodeBase64Unicode(idxData.content);

            if (!raw.includes(`href='${filename}'`) && !raw.includes(`href="${filename}"`)) {
              const newLi = `\n<li><a href='${filename}'>üîç ${displayTitle}</a></li>`;
              const updated = raw.replace('</ul>', `${newLi}\n</ul>`);
              const updRes = await fetch(indexUrl, {
                method: 'PUT',
                headers: {'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json'},
                body: JSON.stringify({
                  message: `Add Trend link: ${displayTitle}`,
                  content: btoa(unescape(encodeURIComponent(updated))),
                  sha: idxSha
                })
              });
              if (!updRes.ok) console.warn('Failed to update index.html automatically');
            }
          }
        } catch (e) {
          console.warn('Could not update index.html:', e);
        }

        const pageUrl = `https://${REPO_OWNER}.github.io/${REPO_NAME}/${filename}`;
        status.innerHTML = `<div class="success">‚úÖ Publi√© !<br>URL: <a href="${pageUrl}" target="_blank">${pageUrl}</a><br><small class="meta">Index label: "${displayTitle}"</small></div>`;
      } catch (e) {
        status.innerHTML = "<div class='error'>‚ùå Erreur r√©seau ou configuration.</div>";
      }
    }
  </script>
</body>
</html>
